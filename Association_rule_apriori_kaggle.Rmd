---
title: "Market Basket Analysis_Kaggle"
author: "HARSHITHA MEKALA"
date: "6 September 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(arulesViz)
library(arules)
library(knitr)
library(gridExtra)

```

# loading the data using read.transactions() from arulers package to create transactions object
```{r}
trans <- read.transactions("E://Machine Learning/My practice/AnalyticsVidhya_dataset/BreadBasket_DMS.csv", rm.duplicates = TRUE, format = "single", cols = c(3,4), sep = ",")

trans
summary(trans)
str(trans)


```

# Data Description
```{r}
"
* DATE : Categorical column that tells the dates of the transcations made in YYYY-MM-DD format. The column includes dates from 30/10/2016 - 9/4/2017

* TIME : Categorical column that tells about the time of transactions in HH:MM:SS format

* TRANSACTION : Quantitative variable that allows us to differentiate the transactions. The rows thats share the same value in thsi field belong to the Same  transaction, that's why the data has less transactions than number of observations

* ITEM : Categorical variable with the products" 
```

# Data Analysis
```{r}
# Before applyinfg the apriori algorithm we can visualise the items using itemFrequencyPlot() which is a bar plot to learn more about transactions

# Absolute item frequency plot

plot1 <- itemFrequencyPlot(trans, 
                           topN = 15, 
                           type = "absolute", 
                           col = "wheat2", 
                           xlab = "Item name", 
                           ylab = "Frequency (absolute)", 
                           main = "Absolute Item Frequency")

plot2 <- itemFrequencyPlot(trans,
                           topN = 15,
                           type = "relative",
                           col = "lightcyan2",
                           xlab = "Item Name",
                           ylab = "Frequency (relative)",
                           main = "Relative Item Frequency")


# From the graph we can find that coffee is the best selling item followed by bread and tea


```
# Applying Apriori Algorithm
```{r}
# choice of support and confidence

# The first step in order to create a set of association rules is to determine the optimal value of threshoulds for support and confidence. If we set these values too low then the algorithm takes much time to execute and hence we get a lot of rules(most of them may not be useful). So we finally do some trial and error method and visualise the rules generated by those values.


supportlevels <- c(0.1, 0.05, 0.01, 0.005)
confidencelevels <- c(0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2, 0.1)

rules_supp_10 <- integer(length = 9)
rules_supp_5 <- integer(length = 9)
rules_supp_1 <- integer(length = 9)
rules_supp_0.5 <- integer(length = 9)


# Apriori algorithm witha a support level of 10%

for(i in 1:length(confidencelevels)){
  rules_supp_10[i] <- length(apriori(trans, 
                                     parameter = list(supp = supportlevels[1], 
                                                      conf = confidencelevels[i],
                                                      target = "rules")))
}

# Apriori algorithm witha a support level of 5%
for(i in 1:length(confidencelevels)){
  rules_supp_5[i] <- length(apriori(trans,
                                    parameter = list(supp = supportlevels[2],
                                                     conf = confidencelevels[i],
                                                     target = "rules")))
}

# Apriori algorithm witha a support level of 1%

for(i in 1:length(confidencelevels)){
  rules_supp_1[i] <- length(apriori(trans, 
                                    parameter = list(supp = supportlevels[3],
                                                     conf = confidencelevels[i],
                                                     target = "rules")))
}

# Apriori algorithm with a support level of 0.5%

for(i in 1:length(confidencelevels)){
  rules_supp_0.5[i] <- length(apriori(trans,
                                  parameter = list(supp = supportlevels[3],
                                                   conf = confidencelevels[i],
                                                   target = "rules")))
}
```


# lets plot a graph to check the number  of rules generated for each support level
```{r}
plot1 <- qplot(confidencelevels, 
                rules_supp_10, 
                geom=c("point", "line"),
                xlab = "confidence level",
                ylab = "Number of rules found",
                main = "Apriori with support level of 10%") + 
  theme_bw()

plot2 <- qplot(confidencelevels, 
               rules_supp_5, 
               geom=c("point", "line"), 
               xlab="Confidence level", 
               ylab="Number of rules found", 
               main="Apriori with a support level of 5%") +
  theme_bw()

plot3 <- qplot(confidencelevels, 
               rules_supp_1, 
               geom=c("point", "line"), 
               xlab="Confidence level", 
               ylab="Number of rules found", 
               main="Apriori with a support level of 1%") +
  theme_bw()


plot4 <- qplot(confidencelevels, 
               rules_supp_0.5, 
               geom=c("point", "line"), 
               xlab="Confidence level", 
               ylab="Number of rules found", 
               main="Apriori with a support level of 0.5%") +
  theme_bw()

# subplot
grid.arrange(plot1, plot2, plot3, plot4, ncol = 2)



```

# we can join four lines to improve the visualization
```{r}
num_rules <- data.frame(rules_supp_10, rules_supp_5, rules_supp_1, rules_supp_0.5)

# Number of rules for the support levels of 10%, 5%, 1% 0.5%

ggplot(data=num_rules, aes(x=confidencelevels)) +
  geom_line(aes(y=rules_supp_10, colour="Support level of 10%")) + 
  geom_point(aes(y=rules_supp_10, colour="Support level of 10%")) +
  
  geom_line(aes(y=rules_supp_5, colour="Support level of 5%")) +
  geom_point(aes(y=rules_supp_5, colour="Support level of 5%")) +
  
  geom_line(aes(y=rules_supp_1, colour="Support level of 1%")) + 
  geom_point(aes(y=rules_supp_1, colour="Support level of 1%")) +
  
  geom_line(aes(y=rules_supp_0.5, colour="Support level of 0.5%")) +
  geom_point(aes(y=rules_supp_0.5, colour="Support level of 0.5%")) +
  
  labs(x="Confidence levels", 
       y="Number of rules found", 
       title="Apriori algorithm with different support levels") +
  theme_bw() +
  theme(legend.title=element_blank())
 
"Let's analyze the results,

Support level of 10%. We only identify a few rules with very low confidence levels. This means that there are no relatively frequent associations in our data set. We can't choose this value, the resulting rules are unrepresentative.

Support level of 5%. We only identify a rule with a confidence of at least 50%. It seems that we have to look for support levels below 5% to obtain a greater number of rules with a reasonable confidence.

Support level of 1%. We started to get dozens of rules, of which 13 have a confidence of at least 50%.

Support level of 0.5%. Too many rules to analyze!

To sum up, we are going to use a support level of 1% and a confidence level of 50%."

```

# lets execute the apriori algorithm with rhw above values of support level 1% and confidence of 50%
```{r}
rules_supp1_confi50 <- apriori(trans, 
                               parameter = list(supp = supportlevels[3], 
                                                conf = confidencelevels[5],
                                                target = "rules"))

inspect(rules_supp1_confi50)

"
54% of the customers who bought tiffin aslo bought coffee
63% of the customers who bought spanish brunch also bought coffee
54% of the customers who bought scone also bought coffee 
etc..
"
```

# visualizing the rules
```{r}
# Scatter plot
plot(rules_supp1_confi50, measure=c("support","lift"), shading="confidence")

```

# The following visualization represents the rules as a graph with items as labeled vertices, and rules represented as vertices connected to items using arrows.
```{r}
  # Graph
plot(rules_supp1_confi50, method="graph")
```
# We can also change the graph layout.
```{r}

# Graph
plot(rules_supp1_confi50, method="graph", control=list(layout=igraph::in_circle()))
```
